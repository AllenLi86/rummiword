<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rummiword - åˆ†é›¢å¼æ¶æ§‹æ¸¬è©¦</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" type="image/png">
  
  <!-- Socket.IO å’Œ Phaser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ========== æˆ¿é–“ç³»çµ±æ¨£å¼ ========== */
    .room-system {
      padding: 20px;
      transition: all 0.5s ease-in-out;
    }

    .room-system.hidden {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: clamp(1.5rem, 4vw, 2rem);
    }

    /* é€£æ¥ç‹€æ…‹ */
    .connection-status {
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .connection-status.success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .connection-status.error {
      background: linear-gradient(135deg, #f8d7da, #f1b0b7);
      color: #721c24;
      border: 1px solid #f1b0b7;
    }

    .connection-status.info {
      background: linear-gradient(135deg, #d1ecf1, #b8daff);
      color: #0c5460;
      border: 1px solid #b8daff;
    }

    /* ç™»å…¥å€æ®µ */
    .login-section {
      text-align: center;
      padding: 40px 0;
    }

    .login-section h2 {
      margin-bottom: 30px;
      color: #495057;
    }

    .login-section input {
      padding: 15px 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin: 10px;
      width: min(300px, 80%);
      transition: border-color 0.3s ease;
    }

    .login-section input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .login-section button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .login-section button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    /* å¤§å»³å€æ®µ */
    .lobby-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    @media (min-width: 768px) {
      .lobby-section {
        grid-template-columns: 2fr 1fr;
      }
    }

    .rooms-list, .create-room {
      background: rgba(248, 249, 250, 0.9);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(222, 226, 230, 0.6);
      backdrop-filter: blur(5px);
    }

    .rooms-list h3, .create-room h3 {
      margin-bottom: 20px;
      color: #495057;
      font-size: 1.2em;
    }

    .room-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      margin: 15px 0;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .room-card:hover {
      border-color: #007bff;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
    }

    .room-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 8px;
      color: #333;
    }

    .room-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .players-count, .room-status {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .players-count {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }

    .room-status.waiting {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .join-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .join-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    /* æ¸¬è©¦æ§åˆ¶é¢æ¿ */
    .test-controls {
      margin-top: 30px;
      padding: 20px;
      background: rgba(255, 248, 220, 0.9);
      border-radius: 10px;
      border: 2px solid #ffc107;
      text-align: center;
    }

    .test-controls h3 {
      color: #856404;
      margin-bottom: 15px;
    }

    .test-btn {
      padding: 12px 25px;
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    /* ========== å…¨å±PhaseréŠæˆ²æ¨£å¼ ========== */
    .game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s ease-in-out;
    }

    .game-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .game-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #phaser-game {
      max-width: 100vw;
      max-height: 100vh;
    }

    .game-ui {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      gap: 10px;
    }

    .game-ui button {
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    .game-ui button:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.05);
    }

    .exit-btn {
      background: rgba(220, 53, 69, 0.8) !important;
    }

    .exit-btn:hover {
      background: rgba(220, 53, 69, 1) !important;
    }

    /* è¼‰å…¥å‹•ç•« */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* éŸ¿æ‡‰å¼å„ªåŒ– */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }

      .game-ui {
        top: 10px;
        right: 10px;
        flex-direction: column;
      }

      .game-ui button {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
  </style>
</head>

<body>
  <!-- ========== æˆ¿é–“ç³»çµ± ========== -->
  <div class="room-system" id="room-system">
    <div class="container">
      <h1>ğŸ® Rummiword - åˆ†é›¢å¼æ¶æ§‹æ¸¬è©¦</h1>

      <!-- é€£æ¥ç‹€æ…‹ -->
      <div id="connection-status" class="connection-status info">
        ğŸ”§ æ¸¬è©¦æ¨¡å¼ - ç„¡éœ€æœå‹™å™¨é€£æ¥
      </div>

      <!-- ç™»å…¥å€æ®µ -->
      <div id="login-section" class="section active">
        <div class="login-section">
          <h2>ğŸ‘¤ è¨­ç½®ä½ çš„åç¨±</h2>
          <div>
            <input type="text" id="player-name-input" placeholder="è¼¸å…¥ä½ çš„åç¨±" maxlength="20">
            <button onclick="setPlayerName()">ç¢ºèª</button>
          </div>
          <p>é€™æ˜¯åˆ†é›¢å¼æ¶æ§‹çš„æ¸¬è©¦ç‰ˆæœ¬</p>
        </div>
      </div>

      <!-- å¤§å»³å€æ®µ -->
      <div id="lobby-section" class="section">
        <div class="lobby-section">
          <!-- æˆ¿é–“åˆ—è¡¨ -->
          <div class="rooms-list">
            <h3>ğŸ  æ¸¬è©¦æˆ¿é–“åˆ—è¡¨</h3>
            <div id="rooms-list">
              <div class="room-card" onclick="joinTestRoom('room1')">
                <div class="room-name">ğŸ¯ PhaseréŸ¿æ‡‰å¼æ¸¬è©¦æˆ¿</div>
                <div class="room-info">
                  <span class="players-count">1/4</span>
                  <span class="room-status waiting">ç­‰å¾…ä¸­</span>
                </div>
                <button class="join-btn">æ¸¬è©¦å…¨å±éŠæˆ²</button>
              </div>
              
              <div class="room-card" onclick="joinTestRoom('room2')">
                <div class="room-name">ğŸ“± ç§»å‹•ç«¯å„ªåŒ–æ¸¬è©¦</div>
                <div class="room-info">
                  <span class="players-count">2/4</span>
                  <span class="room-status waiting">ç­‰å¾…ä¸­</span>
                </div>
                <button class="join-btn">æ¸¬è©¦éŸ¿æ‡‰å¼</button>
              </div>
            </div>
          </div>

          <!-- æ¸¬è©¦æ§åˆ¶ -->
          <div class="create-room">
            <h3>ğŸ”§ æ¸¬è©¦æ§åˆ¶</h3>
            <button class="test-btn" onclick="testFullscreenGame()">ç›´æ¥å•Ÿå‹•å…¨å±éŠæˆ²</button>
            <button class="test-btn" onclick="testResponsive()">æ¸¬è©¦éŸ¿æ‡‰å¼æ•ˆæœ</button>
            <button class="test-btn" onclick="testPerformance()">æ€§èƒ½æ¸¬è©¦æ¨¡å¼</button>
            <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
              <p>ğŸ“‹ æ¸¬è©¦é …ç›®ï¼š</p>
              <p>â€¢ æˆ¿é–“â†’éŠæˆ²éæ¸¡å‹•ç•«</p>
              <p>â€¢ Phaserå…¨å±éŸ¿æ‡‰å¼</p>
              <p>â€¢ æ€§èƒ½å’Œè¨˜æ†¶é«”ä½¿ç”¨</p>
              <p>â€¢ è¿”å›æˆ¿é–“ç³»çµ±</p>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
      <div class="test-controls">
        <h3>ğŸ§ª æ¶æ§‹æ¸¬è©¦é¢æ¿</h3>
        <button class="test-btn" onclick="simulateRoomTransition()">æ¨¡æ“¬æˆ¿é–“åˆ‡æ›</button>
        <button class="test-btn" onclick="checkResponsive()">æª¢æŸ¥éŸ¿æ‡‰å¼</button>
        <button class="test-btn" onclick="measurePerformance()">æ¸¬é‡æ€§èƒ½</button>
      </div>
    </div>
  </div>

  <!-- ========== å…¨å±PhaseréŠæˆ²è¦†è“‹å±¤ ========== -->
  <div class="game-overlay" id="game-overlay">
    <div class="game-container">
      <!-- éŠæˆ²UIæ§åˆ¶ -->
      <div class="game-ui">
        <button onclick="toggleFullscreen()">ğŸ”³ å…¨å±</button>
        <button onclick="showGameStats()">ğŸ“Š çµ±è¨ˆ</button>
        <button class="exit-btn" onclick="exitGame()">âŒ é€€å‡ºéŠæˆ²</button>
      </div>
      
      <!-- PhaseréŠæˆ²å®¹å™¨ -->
      <div id="phaser-game"></div>
      
      <!-- è¼‰å…¥å‹•ç•« -->
      <div class="loading" id="game-loading">
        <div class="spinner"></div>
        <p>è¼‰å…¥PhaseréŠæˆ²ä¸­...</p>
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€è®Šé‡ ==========
    let currentGame = null;
    let gameConfig = null;
    let performanceMonitor = {
      startTime: 0,
      frameCount: 0,
      lastFpsUpdate: 0
    };

    // ========== æˆ¿é–“ç³»çµ±åŠŸèƒ½ ==========
    function setPlayerName() {
      const nameInput = document.getElementById('player-name-input');
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±');
        return;
      }

      // æ¨¡æ“¬è¨­ç½®æˆåŠŸ
      document.getElementById('connection-status').textContent = `âœ… æ­¡è¿, ${name}ï¼`;
      document.getElementById('connection-status').className = 'connection-status success';
      
      showSection('lobby-section');
      console.log(`ğŸ® ç©å®¶ ${name} é€²å…¥å¤§å»³`);
    }

    function joinTestRoom(roomId) {
      console.log(`ğŸ  åŠ å…¥æ¸¬è©¦æˆ¿é–“: ${roomId}`);
      
      // é¡¯ç¤ºé€£æ¥ç‹€æ…‹
      document.getElementById('connection-status').textContent = 'ğŸ® æº–å‚™é€²å…¥éŠæˆ²...';
      document.getElementById('connection-status').className = 'connection-status info';
      
      // å»¶é²å•Ÿå‹•éŠæˆ²ï¼Œæ¨¡æ“¬çœŸå¯¦é€£æ¥
      setTimeout(() => {
        startGame({
          roomId: roomId,
          playerName: document.getElementById('player-name-input').value,
          gameMode: 'test'
        });
      }, 1000);
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');
    }

    // ========== éŠæˆ²å•Ÿå‹•å’Œç®¡ç† ==========
    function startGame(gameData) {
      console.log('ğŸš€ å•Ÿå‹•åˆ†é›¢å¼PhaseréŠæˆ²', gameData);
      
      // éš±è—æˆ¿é–“ç³»çµ±
      const roomSystem = document.getElementById('room-system');
      roomSystem.classList.add('hidden');
      
      // é¡¯ç¤ºéŠæˆ²è¦†è“‹å±¤
      const gameOverlay = document.getElementById('game-overlay');
      gameOverlay.classList.add('active');
      
      // å»¶é²è¼‰å…¥éŠæˆ²ï¼Œç¢ºä¿éæ¸¡å‹•ç•«å®Œæˆ
      setTimeout(() => {
        initializePhaserGame(gameData);
      }, 500);
    }

    function initializePhaserGame(gameData) {
      console.log('ğŸ® åˆå§‹åŒ–PhaseréŠæˆ²');
      
      performanceMonitor.startTime = performance.now();
      
      // éŸ¿æ‡‰å¼è¨ˆç®—éŠæˆ²å°ºå¯¸
      const gameSize = calculateGameSize();
      
      gameConfig = {
        type: Phaser.AUTO,
        width: gameSize.width,
        height: gameSize.height,
        parent: 'phaser-game',
        backgroundColor: '#2c3e50',
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: gameSize.width,
          height: gameSize.height
        },
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 0 },
            debug: false
          }
        },
        scene: {
          preload: preload,
          create: create,
          update: update
        }
      };

      currentGame = new Phaser.Game(gameConfig);
      
      // éš±è—è¼‰å…¥å‹•ç•«
      setTimeout(() => {
        document.getElementById('game-loading').style.display = 'none';
      }, 1500);
    }

    function calculateGameSize() {
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      
      // åŸºç¤éŠæˆ²å°ºå¯¸
      let width = 1200;
      let height = 800;
      
      // éŸ¿æ‡‰å¼èª¿æ•´
      if (vw < 768) {
        // æ‰‹æ©Ÿ
        width = Math.min(vw - 20, 800);
        height = Math.min(vh - 20, 600);
      } else if (vw < 1024) {
        // å¹³æ¿
        width = Math.min(vw - 40, 1000);
        height = Math.min(vh - 40, 700);
      } else {
        // æ¡Œé¢ - ä¿æŒæ¯”ä¾‹
        const ratio = Math.min(vw / width, vh / height) * 0.9;
        width = width * ratio;
        height = height * ratio;
      }
      
      console.log(`ğŸ“ è¨ˆç®—éŠæˆ²å°ºå¯¸: ${width}x${height} (è¦–çª—: ${vw}x${vh})`);
      return { width: Math.floor(width), height: Math.floor(height) };
    }

    // ========== Phaserå ´æ™¯å‡½æ•¸ ==========
    function preload() {
      console.log('ğŸ“¦ Phaser preload');
      
      // å‰µå»ºç°¡å–®çš„å½©è‰²æ–¹å¡Šä½œç‚ºæ¸¬è©¦ç´ æ
      this.load.image('bg', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI9jU77zgAAAABJRU5ErkJggg==');
      
      // è¼‰å…¥é€²åº¦æ¢
      const progressBar = this.add.graphics();
      const progressBox = this.add.graphics();
      progressBox.fillStyle(0x222222);
      progressBox.fillRect(this.cameras.main.width / 2 - 160, this.cameras.main.height / 2 - 25, 320, 50);
      
      this.load.on('progress', (value) => {
        progressBar.clear();
        progressBar.fillStyle(0x00ff00);
        progressBar.fillRect(this.cameras.main.width / 2 - 150, this.cameras.main.height / 2 - 15, 300 * value, 30);
      });
    }

    function create() {
      console.log('ğŸ¨ Phaser create');
      const scene = this;
      
      // èƒŒæ™¯æ¼¸å±¤
      const graphics = this.add.graphics();
      graphics.fillGradientStyle(0x2c3e50, 0x3498db, 0x2c3e50, 0x3498db);
      graphics.fillRect(0, 0, this.cameras.main.width, this.cameras.main.height);
      
      // éŠæˆ²æ¨™é¡Œ
      const title = this.add.text(this.cameras.main.width / 2, 100, 'ğŸ® Rummiword Phaseræ¸¬è©¦', {
        fontSize: this.cameras.main.width < 768 ? '24px' : '36px',
        fontFamily: 'Arial',
        color: '#ffffff',
        fontStyle: 'bold'
      }).setOrigin(0.5);
      
      // éŸ¿æ‡‰å¼è³‡è¨Šé¡¯ç¤º
      const deviceInfo = getDeviceInfo();
      const infoText = this.add.text(this.cameras.main.width / 2, 160, deviceInfo, {
        fontSize: this.cameras.main.width < 768 ? '14px' : '18px',
        fontFamily: 'Arial',
        color: '#ecf0f1',
        align: 'center'
      }).setOrigin(0.5);
      
      // å‰µå»ºæ¸¬è©¦å…ƒç´ 
      createTestElements(scene);
      
      // æ€§èƒ½ç›£æ§
      createPerformanceDisplay(scene);
      
      // è§¸æ§/é¼ æ¨™äº‹ä»¶æ¸¬è©¦
      setupInputTests(scene);
      
      console.log('âœ… Phaserå ´æ™¯å‰µå»ºå®Œæˆ');
    }

    function update() {
      // æ€§èƒ½ç›£æ§
      updatePerformanceMonitor(this);
    }

    function createTestElements(scene) {
      const centerX = scene.cameras.main.width / 2;
      const centerY = scene.cameras.main.height / 2;
      
      // äº’å‹•æ¸¬è©¦æ–¹å¡Š
      for (let i = 0; i < 5; i++) {
        const box = scene.add.rectangle(
          centerX - 200 + (i * 100), 
          centerY, 
          60, 60, 
          Phaser.Display.Color.HSVToRGB(i * 0.2, 1, 1).color
        );
        
        box.setInteractive({ cursor: 'pointer' });
        box.setStrokeStyle(2, 0xffffff);
        
        // æ·»åŠ å‹•ç•«
        scene.tweens.add({
          targets: box,
          y: centerY - 20,
          duration: 1000 + (i * 200),
          yoyo: true,
          repeat: -1,
          ease: 'Power2'
        });
        
        // é»æ“Šæ•ˆæœ
        box.on('pointerdown', () => {
          scene.tweens.add({
            targets: box,
            scaleX: 1.2,
            scaleY: 1.2,
            duration: 100,
            yoyo: true,
            ease: 'Power2'
          });
          
          // å‰µå»ºç²’å­æ•ˆæœ
          createParticleEffect(scene, box.x, box.y);
        });
      }
      
      // æ·»åŠ èªªæ˜æ–‡å­—
      scene.add.text(centerX, centerY + 100, 'é»æ“Šå½©è‰²æ–¹å¡Šæ¸¬è©¦äº’å‹•æ•ˆæœ', {
        fontSize: scene.cameras.main.width < 768 ? '14px' : '18px',
        fontFamily: 'Arial',
        color: '#ffffff',
        align: 'center'
      }).setOrigin(0.5);
    }

    function createParticleEffect(scene, x, y) {
      // ç°¡å–®çš„ç²’å­çˆ†ç‚¸æ•ˆæœ
      for (let i = 0; i < 10; i++) {
        const particle = scene.add.rectangle(x, y, 4, 4, 0xffffff);
        const angle = (Math.PI * 2 * i) / 10;
        const speed = 50 + Math.random() * 50;
        
        scene.tweens.add({
          targets: particle,
          x: x + Math.cos(angle) * speed,
          y: y + Math.sin(angle) * speed,
          alpha: 0,
          duration: 500,
          ease: 'Power2',
          onComplete: () => particle.destroy()
        });
      }
    }

    function createPerformanceDisplay(scene) {
      // FPSé¡¯ç¤º
      scene.fpsText = scene.add.text(20, 20, 'FPS: --', {
        fontSize: '16px',
        fontFamily: 'monospace',
        color: '#00ff00',
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        padding: { x: 5, y: 5 }
      });
      
      // è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (performance.memory) {
        scene.memoryText = scene.add.text(20, 50, 'Memory: --', {
          fontSize: '14px',
          fontFamily: 'monospace',
          color: '#ffff00',
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          padding: { x: 5, y: 5 }
        });
      }
      
      // éŠæˆ²å°ºå¯¸è³‡è¨Š
      scene.sizeText = scene.add.text(20, 80, `Size: ${scene.cameras.main.width}x${scene.cameras.main.height}`, {
        fontSize: '14px',
        fontFamily: 'monospace',
        color: '#00ffff',
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        padding: { x: 5, y: 5 }
      });
    }

    function updatePerformanceMonitor(scene) {
      performanceMonitor.frameCount++;
      const now = performance.now();
      
      if (now - performanceMonitor.lastFpsUpdate > 1000) {
        const fps = Math.round(performanceMonitor.frameCount * 1000 / (now - performanceMonitor.lastFpsUpdate));
        if (scene.fpsText) {
          scene.fpsText.setText(`FPS: ${fps}`);
        }
        
        if (scene.memoryText && performance.memory) {
          const memory = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
          scene.memoryText.setText(`Memory: ${memory} MB`);
        }
        
        performanceMonitor.frameCount = 0;
        performanceMonitor.lastFpsUpdate = now;
      }
    }

    function setupInputTests(scene) {
      // éµç›¤äº‹ä»¶
      const cursors = scene.input.keyboard.createCursorKeys();
      const wasd = scene.input.keyboard.addKeys('W,S,A,D');
      
      // ESCéµé€€å‡ºéŠæˆ²
      scene.input.keyboard.on('keydown-ESC', () => {
        exitGame();
      });
      
      // å…¨å±åˆ‡æ›
      scene.input.keyboard.on('keydown-F', () => {
        toggleFullscreen();
      });
    }

    function getDeviceInfo() {
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const dpr = window.devicePixelRatio || 1;
      const userAgent = navigator.userAgent;
      
      let deviceType = 'ğŸ–¥ï¸ æ¡Œé¢';
      if (/Mobi|Android/i.test(userAgent)) {
        deviceType = 'ğŸ“± æ‰‹æ©Ÿ';
      } else if (/Tablet|iPad/i.test(userAgent)) {
        deviceType = 'ğŸ“± å¹³æ¿';
      }
      
      return `${deviceType} | è¢å¹•: ${vw}x${vh} | DPR: ${dpr}`;
    }

    // ========== éŠæˆ²æ§åˆ¶åŠŸèƒ½ ==========
    function exitGame() {
      console.log('ğŸšª é€€å‡ºéŠæˆ²');
      
      if (currentGame) {
        currentGame.destroy(true);
        currentGame = null;
      }
      
      // éš±è—éŠæˆ²è¦†è“‹å±¤
      const gameOverlay = document.getElementById('game-overlay');
      gameOverlay.classList.remove('active');
      
      // é¡¯ç¤ºæˆ¿é–“ç³»çµ±
      const roomSystem = document.getElementById('room-system');
      roomSystem.classList.remove('hidden');
      
      // æ¸…ç©ºéŠæˆ²å®¹å™¨
      document.getElementById('phaser-game').innerHTML = '';
      
      // é¡¯ç¤ºè¼‰å…¥å‹•ç•«ï¼ˆç‚ºä¸‹æ¬¡éŠæˆ²æº–å‚™ï¼‰
      document.getElementById('game-loading').style.display = 'block';
      
      // æ›´æ–°é€£æ¥ç‹€æ…‹
      document.getElementById('connection-status').textContent = 'ğŸ  å·²è¿”å›æˆ¿é–“ç³»çµ±';
      document.getElementById('connection-status').className = 'connection-status success';
      
      console.log('âœ… æˆåŠŸè¿”å›æˆ¿é–“ç³»çµ±');
    }

    function toggleFullscreen() {
      if (document.fullscreenElement) {
        document.exitFullscreen().then(() => {
          console.log('ğŸ“± é€€å‡ºå…¨å±æ¨¡å¼');
        });
      } else {
        document.documentElement.requestFullscreen().then(() => {
          console.log('ğŸ”³ é€²å…¥å…¨å±æ¨¡å¼');
          
          // é‡æ–°è¨ˆç®—éŠæˆ²å°ºå¯¸
          setTimeout(() => {
            if (currentGame) {
              const newSize = calculateGameSize();
              currentGame.scale.resize(newSize.width, newSize.height);
            }
          }, 100);
        });
      }
    }

    function showGameStats() {
      if (!currentGame) return;
      
      const stats = {
        fps: currentGame.loop.actualFps.toFixed(1),
        memory: performance.memory ? (performance.memory.usedJSHeapSize / 1048576).toFixed(1) + ' MB' : 'N/A',
        gameSize: `${currentGame.config.width}x${currentGame.config.height}`,
        windowSize: `${window.innerWidth}x${window.innerHeight}`,
        uptime: ((performance.now() - performanceMonitor.startTime) / 1000).toFixed(1) + 's'
      };
      
      const statsText = `
ğŸ® éŠæˆ²çµ±è¨ˆè³‡è¨Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š FPS: ${stats.fps}
ğŸ’¾ è¨˜æ†¶é«”: ${stats.memory}
ğŸ¯ éŠæˆ²å°ºå¯¸: ${stats.gameSize}
ğŸ–¥ï¸ è¦–çª—å°ºå¯¸: ${stats.windowSize}
â±ï¸ é‹è¡Œæ™‚é–“: ${stats.uptime}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      `;
      
      alert(statsText);
      console.log('ğŸ“Š éŠæˆ²çµ±è¨ˆ:', stats);
    }

    // ========== æ¸¬è©¦åŠŸèƒ½ ==========
    function testFullscreenGame() {
      console.log('ğŸ§ª ç›´æ¥æ¸¬è©¦å…¨å±éŠæˆ²');
      startGame({
        roomId: 'direct-test',
        playerName: 'Test Player',
        gameMode: 'fullscreen-test'
      });
    }

    function testResponsive() {
      console.log('ğŸ“± æ¸¬è©¦éŸ¿æ‡‰å¼æ•ˆæœ');
      
      const testSizes = [
        { width: 1920, height: 1080, name: '1920x1080 (æ¡Œé¢)' },
        { width: 1366, height: 768, name: '1366x768 (ç­†é›»)' },
        { width: 768, height: 1024, name: '768x1024 (å¹³æ¿)' },
        { width: 375, height: 667, name: '375x667 (æ‰‹æ©Ÿ)' }
      ];
      
      let currentIndex = 0;
      
      const testNextSize = () => {
        if (currentIndex >= testSizes.length) {
          alert('ğŸ“± éŸ¿æ‡‰å¼æ¸¬è©¦å®Œæˆï¼');
          return;
        }
        
        const size = testSizes[currentIndex];
        
        // æ¨¡æ“¬è¦–çª—å¤§å°è®ŠåŒ–
        if (currentGame) {
          const mockSize = calculateGameSize();
          currentGame.scale.resize(mockSize.width, mockSize.height);
        }
        
        console.log(`ğŸ“ æ¸¬è©¦å°ºå¯¸: ${size.name}`);
        
        setTimeout(() => {
          currentIndex++;
          testNextSize();
        }, 2000);
      };
      
      if (!currentGame) {
        startGame({ gameMode: 'responsive-test' });
        setTimeout(testNextSize, 2000);
      } else {
        testNextSize();
      }
    }

    function testPerformance() {
      console.log('âš¡ å•Ÿå‹•æ€§èƒ½æ¸¬è©¦æ¨¡å¼');
      
      if (currentGame) {
        // å‰µå»ºå¤§é‡ç‰©ä»¶é€²è¡Œæ€§èƒ½æ¸¬è©¦
        const scene = currentGame.scene.scenes[0];
        
        for (let i = 0; i < 100; i++) {
          const sprite = scene.add.rectangle(
            Math.random() * scene.cameras.main.width,
            Math.random() * scene.cameras.main.height,
            10, 10,
            Phaser.Display.Color.RandomRGB().color
          );
          
          scene.tweens.add({
            targets: sprite,
            x: Math.random() * scene.cameras.main.width,
            y: Math.random() * scene.cameras.main.height,
            duration: 2000 + Math.random() * 2000,
            repeat: -1,
            yoyo: true
          });
        }
        
        alert('âš¡ å·²æ·»åŠ 100å€‹å‹•ç•«ç‰©ä»¶é€²è¡Œæ€§èƒ½æ¸¬è©¦');
      } else {
        startGame({ gameMode: 'performance-test' });
      }
    }

    function simulateRoomTransition() {
      console.log('ğŸ”„ æ¨¡æ“¬æˆ¿é–“åˆ‡æ›');
      
      let step = 0;
      const steps = [
        'ğŸ  æˆ¿é–“ç³»çµ±é¡¯ç¤ºä¸­',
        'ğŸ® æº–å‚™é€²å…¥éŠæˆ²',
        'ğŸ“¦ è¼‰å…¥PhaseréŠæˆ²',
        'âœ… éŠæˆ²é‹è¡Œä¸­',
        'ğŸšª æº–å‚™é€€å‡ºéŠæˆ²',
        'ğŸ  è¿”å›æˆ¿é–“ç³»çµ±'
      ];
      
      const runStep = () => {
        if (step >= steps.length) {
          console.log('âœ… æˆ¿é–“åˆ‡æ›æ¸¬è©¦å®Œæˆ');
          return;
        }
        
        document.getElementById('connection-status').textContent = steps[step];
        console.log(steps[step]);
        
        switch (step) {
          case 1: // æº–å‚™é€²å…¥éŠæˆ²
            setTimeout(() => {
              document.getElementById('room-system').classList.add('hidden');
              document.getElementById('game-overlay').classList.add('active');
            }, 1000);
            break;
            
          case 2: // è¼‰å…¥éŠæˆ²
            setTimeout(() => {
              if (!currentGame) {
                initializePhaserGame({ gameMode: 'transition-test' });
              }
            }, 1000);
            break;
            
          case 4: // æº–å‚™é€€å‡º
            setTimeout(() => {
              if (currentGame) {
                currentGame.destroy(true);
                currentGame = null;
              }
              document.getElementById('game-overlay').classList.remove('active');
              document.getElementById('room-system').classList.remove('hidden');
            }, 1000);
            break;
        }
        
        step++;
        setTimeout(runStep, 2000);
      };
      
      runStep();
    }

    function checkResponsive() {
      const info = {
        viewport: `${window.innerWidth}x${window.innerHeight}`,
        devicePixelRatio: window.devicePixelRatio,
        orientation: window.innerHeight > window.innerWidth ? 'è±å±' : 'æ©«å±',
        userAgent: navigator.userAgent.includes('Mobile') ? 'ç§»å‹•è¨­å‚™' : 'æ¡Œé¢è¨­å‚™',
        gameSize: currentGame ? `${currentGame.config.width}x${currentGame.config.height}` : 'æœªé‹è¡Œ'
      };
      
      const infoText = `
ğŸ“± éŸ¿æ‡‰å¼æª¢æŸ¥çµæœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ–¥ï¸ è¦–çª—å°ºå¯¸: ${info.viewport}
ğŸ“ åƒç´ æ¯”ç‡: ${info.devicePixelRatio}
ğŸ”„ è¢å¹•æ–¹å‘: ${info.orientation}
ğŸ“± è¨­å‚™é¡å‹: ${info.userAgent}
ğŸ® éŠæˆ²å°ºå¯¸: ${info.gameSize}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      `;
      
      alert(infoText);
      console.log('ğŸ“± éŸ¿æ‡‰å¼è³‡è¨Š:', info);
    }

    function measurePerformance() {
      console.log('ğŸ“Š é–‹å§‹æ€§èƒ½æ¸¬é‡');
      
      const startTime = performance.now();
      let frameCount = 0;
      let maxMemory = 0;
      
      const measure = () => {
        frameCount++;
        
        if (performance.memory) {
          const currentMemory = performance.memory.usedJSHeapSize / 1048576;
          maxMemory = Math.max(maxMemory, currentMemory);
        }
        
        if (frameCount < 300) { // æ¸¬é‡5ç§’ï¼ˆ60fpsï¼‰
          requestAnimationFrame(measure);
        } else {
          const endTime = performance.now();
          const avgFps = frameCount / ((endTime - startTime) / 1000);
          
          const result = `
âš¡ æ€§èƒ½æ¸¬é‡çµæœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ å¹³å‡FPS: ${avgFps.toFixed(1)}
ğŸ’¾ æœ€é«˜è¨˜æ†¶é«”: ${maxMemory.toFixed(1)} MB
â±ï¸ æ¸¬é‡æ™‚é–“: ${((endTime - startTime) / 1000).toFixed(1)}s
ğŸ“Š ç¸½å¹€æ•¸: ${frameCount}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          `;
          
          alert(result);
          console.log('ğŸ“Š æ€§èƒ½çµæœ:', { avgFps, maxMemory, duration: endTime - startTime });
        }
      };
      
      requestAnimationFrame(measure);
    }

    // ========== äº‹ä»¶ç›£è½å™¨ ==========
    
    // è¦–çª—å¤§å°è®ŠåŒ–
    window.addEventListener('resize', () => {
      if (currentGame) {
        setTimeout(() => {
          const newSize = calculateGameSize();
          currentGame.scale.resize(newSize.width, newSize.height);
          console.log(`ğŸ“ è¦–çª—èª¿æ•´ï¼Œæ–°éŠæˆ²å°ºå¯¸: ${newSize.width}x${newSize.height}`);
        }, 100);
      }
    });

    // æ–¹å‘è®ŠåŒ–ï¼ˆç§»å‹•è¨­å‚™ï¼‰
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (currentGame) {
          const newSize = calculateGameSize();
          currentGame.scale.resize(newSize.width, newSize.height);
          console.log('ğŸ”„ è¢å¹•æ–¹å‘è®ŠåŒ–ï¼Œé‡æ–°è¨ˆç®—éŠæˆ²å°ºå¯¸');
        }
      }, 500);
    });

    // å…¨å±ç‹€æ…‹è®ŠåŒ–
    document.addEventListener('fullscreenchange', () => {
      console.log('ğŸ”³ å…¨å±ç‹€æ…‹è®ŠåŒ–:', document.fullscreenElement ? 'é€²å…¥' : 'é€€å‡º');
      
      if (currentGame) {
        setTimeout(() => {
          const newSize = calculateGameSize();
          currentGame.scale.resize(newSize.width, newSize.height);
        }, 100);
      }
    });

    // éµç›¤å¿«æ·éµ
    document.addEventListener('keydown', (event) => {
      // ESCé€€å‡ºéŠæˆ²
      if (event.key === 'Escape' && currentGame) {
        exitGame();
      }
      
      // F11åˆ‡æ›å…¨å±ï¼ˆé˜»æ­¢é»˜èªè¡Œç‚ºï¼‰
      if (event.key === 'F11') {
        event.preventDefault();
        toggleFullscreen();
      }
    });

    // ========== åˆå§‹åŒ– ==========
    console.log('ğŸš€ åˆ†é›¢å¼æ¶æ§‹æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
    console.log('ğŸ“‹ å¯ç”¨æ¸¬è©¦åŠŸèƒ½:', {
      'æˆ¿é–“ç³»çµ±': 'âœ… HTML + CSSéŸ¿æ‡‰å¼',
      'PhaseréŠæˆ²': 'âœ… å…¨å±éŠæˆ²æ¨¡å¼',
      'åˆ‡æ›å‹•ç•«': 'âœ… å¹³æ»‘éæ¸¡æ•ˆæœ',
      'æ€§èƒ½ç›£æ§': 'âœ… FPSå’Œè¨˜æ†¶é«”ç›£æ§',
      'éŸ¿æ‡‰å¼': 'âœ… è‡ªå‹•å°ºå¯¸èª¿æ•´',
      'å¿«æ·éµ': 'âœ… ESCé€€å‡ºï¼ŒF11å…¨å±'
    });
  </script>
</body>
</html>