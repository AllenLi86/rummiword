<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rummiword</title>
  <!-- Socket.IO 客戶端 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    /* 連接狀態 */
    .connection-status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .connection-status.success {
      background: #d4edda;
      color: #155724;
    }

    .connection-status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .connection-status.warning {
      background: #fff3cd;
      color: #856404;
    }

    .connection-status.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    /* 玩家資訊 */
    .player-info {
      text-align: center;
      margin-bottom: 20px;
    }

    .player-card {
      display: inline-block;
      background: #f8f9fa;
      padding: 10px 20px;
      border-radius: 20px;
      border: 2px solid #007bff;
    }

    .player-name {
      font-weight: bold;
      color: #007bff;
    }

    .player-id {
      color: #666;
      font-size: 0.8em;
    }

    /* 界面區段 */
    .section {
      display: none;
      min-height: 400px;
    }

    .section.active {
      display: block;
    }

    /* 登入區段 */
    .login-section {
      text-align: center;
      padding: 40px 0;
    }

    .login-section input {
      padding: 12px 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin: 0 10px 20px 0;
      width: 250px;
    }

    .login-section button {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }

    .login-section button:hover {
      background: #0056b3;
    }

    /* 大廳區段 */
    .lobby-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .rooms-list {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      max-height: 400px;
      overflow-y: auto;
    }

    .rooms-list h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .room-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .room-card:hover {
      border-color: #007bff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .room-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }

    .room-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .players-count {
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
    }

    .room-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .room-status.waiting {
      background: #28a745;
      color: white;
    }

    .room-status.playing {
      background: #ffc107;
      color: #212529;
    }

    .room-status.finished {
      background: #6c757d;
      color: white;
    }

    .join-btn {
      width: 100%;
      padding: 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .join-btn:hover {
      background: #218838;
    }

    .join-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .no-rooms {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 40px;
    }

    /* 創建房間區域 */
    .create-room {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #dee2e6;
    }

    .create-room h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .create-room input,
    .create-room select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .create-room button {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .create-room button:hover {
      background: #0056b3;
    }

    /* 房間區段 */
    .room-section {
      text-align: center;
      padding: 20px 0;
    }

    .room-header {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .room-players {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .player-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
      transition: all 0.2s ease;
    }

    .player-item.ready {
      border-color: #28a745;
      background: #f8fff9;
    }

    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .player-status {
      font-size: 0.9em;
      color: #6c757d;
    }

    .room-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }

    .room-actions button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ready-btn {
      background: #ffc107;
      color: #212529;
    }

    .ready-btn:hover {
      background: #e0a800;
    }

    .ready-btn.ready {
      background: #28a745;
      color: white;
    }

    .ready-btn.ready:hover {
      background: #218838;
    }

    .start-btn {
      background: #007bff;
      color: white;
    }

    .start-btn:hover {
      background: #0056b3;
    }

    .start-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .leave-btn {
      background: #dc3545;
      color: white;
    }

    .leave-btn:hover {
      background: #c82333;
    }

    /* 遊戲區段 */
    .game-section {
      min-height: 500px;
      padding: 20px;
    }

    .game-placeholder {
      text-align: center;
      padding: 60px 20px;
      background: #f8f9fa;
      border-radius: 15px;
      border: 3px dashed #007bff;
    }

    /* 訊息區域 */
    .messages {
      height: 150px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      font-family: monospace;
      font-size: 13px;
      margin-top: 20px;
    }

    .message {
      margin: 3px 0;
      padding: 2px 5px;
      border-radius: 3px;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
    }

    .message.warning {
      background: #fff3cd;
      color: #856404;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .name-options {
      margin-top: 15px;
    }

    .clear-name-btn {
      background: #6c757d;
      font-size: 14px;
      padding: 8px 16px;
    }

    .clear-name-btn:hover {
      background: #5a6268;
    }

    .change-name-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 10px;
      padding: 5px;
      border-radius: 50%;
      font-size: 14px;
    }

    .change-name-btn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .lobby-section {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .room-players {
        grid-template-columns: 1fr;
      }

      .room-actions {
        flex-direction: column;
        align-items: center;
      }

      .room-actions button {
        width: 80%;
        max-width: 300px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🎮 Rummiword - v0.1.0 版 (字母磚系統)</h1>

    <!-- 連接狀態 -->
    <div id="connection-status" class="connection-status info">
      正在連接服務器...
    </div>

    <!-- 玩家資訊 -->
    <div id="player-info" class="player-info" style="display: none;"></div>

    <!-- 登入區段 -->
    <div id="login-section" class="section active">
      <div class="login-section">
        <h2>👤 設置你的名稱</h2>
        <div>
          <input type="text" id="player-name-input" placeholder="輸入你的名稱" maxlength="20"
            onkeypress="if(event.key==='Enter') setPlayerNameFromInput()">
          <button onclick="setPlayerNameFromInput()">確認</button>
        </div>

        <div class="name-options">
          <button class="clear-name-btn" onclick="clearSavedName()" title="清除保存的名稱">
            🗑️ 清除保存的名稱
          </button>
        </div>

        <p>輸入名稱後可以看到房間列表</p>
      </div>
    </div>

    <!-- 大廳區段 -->
    <div id="lobby-section" class="section">
      <div class="lobby-section">
        <!-- 房間列表 -->
        <div class="rooms-list">
          <h3>🏠 房間列表</h3>
          <div id="rooms-list">
            <div class="no-rooms">載入中...</div>
          </div>
        </div>

        <!-- 創建房間 -->
        <div class="create-room">
          <h3>➕ 創建房間</h3>
          <input type="text" id="room-name-input" placeholder="房間名稱" maxlength="30">
          <select id="max-players-select">
            <option value="2">2人</option>
            <option value="3">3人</option>
            <option value="4" selected>4人</option>
            <option value="5">5人</option>
            <option value="6">6人</option>
          </select>
          <button onclick="createRoomFromInput()">創建房間</button>
        </div>
      </div>
    </div>

    <!-- 房間區段 -->
    <div id="room-section" class="section">
      <div class="room-section">
        <div id="room-info" class="room-header">
          <h2>房間資訊</h2>
        </div>

        <div id="room-players-list" class="room-players">
          <!-- 動態填充玩家列表 -->
        </div>

        <div class="room-actions">
          <button id="ready-btn" class="ready-btn" onclick="toggleReady()">
            準備
          </button>
          <button id="start-game-btn" class="start-btn" onclick="startGame()" disabled>
            等待玩家準備...
          </button>
          <button class="leave-btn" onclick="leaveRoom()">
            離開房間
          </button>
        </div>
      </div>
    </div>

    <!-- 遊戲區段 -->
    <div id="game-section" class="section">
      <div id="game-area" class="game-section">
        <!-- 遊戲界面將在這裡動態載入 -->
        <div class="game-placeholder">
          <h2>🎮 載入中...</h2>
          <p>正在初始化字母磚系統...</p>
        </div>
      </div>
    </div>

    <!-- 訊息區域 -->
    <div id="game-messages" class="messages"></div>
  </div>

  <!-- 載入 JavaScript 檔案 - 正確的順序很重要！ -->
  <script src="socket-client.js"></script>
  <script src="tile-system.js"></script>
  <script src="game-ui-tiles-fixed.js"></script>
  <script src="socket-client-tiles-extension-fixed.js"></script>
  <script src="game-websocket-updated.js"></script>
  <script src="test-tile-interface.js"></script>
  <script src="debug-checker.js"></script>

  <script>
    // 確保初始化函數在所有檔案載入後執行
    let initializationComplete = false;
    
    // 檢查所有必要的對象是否已載入
    function checkInitialization() {
      const required = [
        'SocketClient',
        'TileSystem',
        'tileUIManager',
        'initializeTileSystemExtension'
      ];
      
      const missing = required.filter(name => typeof window[name] === 'undefined');
      
      if (missing.length === 0) {
        console.log('✅ 所有必要組件已載入');
        return true;
      } else {
        console.log('⏳ 等待載入:', missing.join(', '));
        return false;
      }
    }

    // 強制初始化字母磚系統
    function forceInitializeTileSystem() {
      console.log('🔧 強制初始化字母磚系統...');
      
      // 檢查並初始化
      if (checkInitialization()) {
        if (typeof initializeTileSystemExtension === 'function') {
          initializeTileSystemExtension();
          initializationComplete = true;
          console.log('✅ 字母磚系統初始化完成');
        }
      } else {
        console.log('❌ 無法初始化，缺少必要組件');
      }
    }

    // 覆蓋原來的 startGameInterface 函數
    window.originalStartGameInterface = window.startGameInterface;
    
    window.startGameInterface = function(gameData) {
      console.log('🎮 啟動字母磚遊戲界面 (覆蓋版本)', gameData);
      
      // 切換到遊戲區段
      showSection('game-section');
      
      // 確保字母磚系統已初始化
      if (!initializationComplete) {
        console.log('🔧 字母磚系統未初始化，現在初始化...');
        forceInitializeTileSystem();
      }
      
      // 等待一下然後創建界面
      setTimeout(() => {
        if (typeof tileUIManager !== 'undefined' && tileUIManager.createGameInterface) {
          console.log('✅ 使用字母磚 UI 管理器');
          tileUIManager.createGameInterface(gameData);
          
          // 請求手牌數據
          setTimeout(() => {
            if (socketClient && socketClient.requestMyHand) {
              socketClient.requestMyHand();
            } else {
              console.log('⚠️ requestMyHand 方法不可用，使用測試數據');
              // 使用測試數據
              if (typeof generateMockTileData === 'function') {
                const mockData = {
                  tiles: generateMockTileData(),
                  statistics: { totalTiles: 7, totalPoints: 14 }
                };
                tileUIManager.updateMyHand(mockData);
              }
            }
          }, 1000);
          
        } else {
          console.log('❌ TileUIManager 不可用，使用基本界面');
          showBasicGameInterface(gameData);
        }
      }, 500);
    };

    // 基本遊戲界面（調試用）
    function showBasicGameInterface(gameData) {
      const gameAreaEl = document.getElementById('game-area');
      if (gameAreaEl) {
        gameAreaEl.innerHTML = `
          <div class="game-placeholder">
            <h2>🎮 遊戲開始了！</h2>
            <div class="game-info">
              <p><strong>參與玩家:</strong> ${gameData.players.map(p => p.name).join(', ')}</p>
              <p><strong>當前回合:</strong> ${gameData.round}</p>
              <p><strong>遊戲狀態:</strong> ${gameData.status}</p>
            </div>
            <div class="game-placeholder-content">
              <p>🔧 字母磚系統載入中...</p>
              <p>📝 如果持續看到此訊息，表示有初始化問題</p>
              <div style="margin: 20px 0;">
                <button class="control-btn" onclick="forceInitializeTileSystem()">🔧 重新初始化</button>
                <button class="control-btn" onclick="requestMyHand()">🎯 請求手牌</button>
                <button class="control-btn" onclick="testTileSystem()">🧪 測試系統</button>
                <button class="control-btn" onclick="debugTileSystem()">🐛 調試資訊</button>
              </div>
            </div>
            <div class="game-actions">
              <button class="leave-btn" onclick="leaveRoom()">離開遊戲</button>
            </div>
          </div>
        `;
      }
    }

    // 界面切換函數
    function showSection(sectionId) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.add('active');
      }
    }

    // 調試函數
    window.debugTileSystem = function() {
      console.log('=== 字母磚系統調試資訊 ===');
      console.log('SocketClient 載入:', typeof SocketClient !== 'undefined');
      console.log('TileSystem 載入:', typeof window.TileSystem !== 'undefined');
      console.log('tileUIManager 載入:', typeof tileUIManager !== 'undefined');
      console.log('socketClient 實例:', typeof socketClient !== 'undefined');
      console.log('initializeTileSystemExtension:', typeof initializeTileSystemExtension !== 'undefined');
      
      if (typeof socketClient !== 'undefined' && socketClient) {
        console.log('Socket 連接狀態:', socketClient.isConnected ? socketClient.isConnected() : '未知');
        console.log('字母磚方法可用:', !!socketClient.requestMyHand);
      }
      
      console.log('初始化狀態:', initializationComplete);
    };

    // 測試手動創建字母磚界面
    window.createTileUIManually = function() {
      console.log('🔧 手動創建字母磚界面...');
      
      const gameAreaEl = document.getElementById('game-area');
      if (!gameAreaEl) return;
      
      gameAreaEl.innerHTML = `
        <div class="rummi-game-container">
          <div class="game-header">
            <div class="game-info">
              <h2>🎮 Rummiword 遊戲</h2>
              <div class="game-stats">
                <span class="current-player">當前玩家: <strong>測試玩家</strong></span>
                <span class="round-info">回合: 1</span>
                <span class="pool-count">剩餘磚塊: <span id="pool-count">98</span></span>
              </div>
            </div>
            <div class="game-actions">
              <button class="control-btn" onclick="requestMyHand()">🎯 請求手牌</button>
              <button class="control-btn" onclick="debugTileSystem()">🐛 調試</button>
              <button class="leave-btn" onclick="leaveRoom()">離開遊戲</button>
            </div>
          </div>
          
          <div class="my-hand-container">
            <div class="hand-header">
              <h3>🎯 我的手牌</h3>
              <div class="hand-stats">
                <span id="hand-count">7 張</span>
                <span id="hand-score">14 分</span>
              </div>
            </div>
            <div id="my-hand" class="hand-tiles">
              <div class="tile" data-tile-id="test1">
                <div class="tile-letter">A</div>
                <div class="tile-points">1</div>
              </div>
              <div class="tile" data-tile-id="test2">
                <div class="tile-letter">B</div>
                <div class="tile-points">3</div>
              </div>
              <div class="tile blank" data-tile-id="test3">
                <div class="tile-letter">★</div>
                <div class="tile-points"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      console.log('✅ 手動界面創建完成');
    };

    // 等待所有組件載入
    let loadCheckCount = 0;
    const maxLoadChecks = 50; // 5秒超時
    
    function waitForComponents() {
      loadCheckCount++;
      
      if (checkInitialization()) {
        console.log('✅ 所有組件已載入，進行初始化');
        forceInitializeTileSystem();
      } else if (loadCheckCount < maxLoadChecks) {
        setTimeout(waitForComponents, 100);
      } else {
        console.log('⚠️ 組件載入超時，但仍然嘗試初始化');
        forceInitializeTileSystem();
      }
    }
    
    // 啟動檢查
    setTimeout(waitForComponents, 1000);
  </script>
</body>

</html>